#### 前言
庚正计划的[H5宣传动画(手机环境观看)](http://market.m.showjoy.com/activity/ctopic/39978.html)，总体的效果还是很不错的，所以和大家从技术的实现层面上进行一定的分享。其实在当前的互联网环境下，这样的动画宣传在很多其他的公司都有制作（[阿迪达斯宣传H5页面](http://drose6.adidasevent.com/?from=singlemessage&isappinstalled=0)），而且在制作的精良程度以及整体的震撼程度都非常高，带来了很好的传播效果。那在本篇中，我将主要针对在这一次页面制作中自己学习到或者是遇到的一些技术问题来给大家进行分享。
#### 图片加载统计

![](http://cdn1.showjoy.com/images/37/377b0d7bd98f4f03a6974932a34e5e4b.png)

在这一类的动画宣传页面中，内容以图片为主，所以我们需要在页面图片加载完成之前进行一个图片已加载完成数量的判断，以免我们的图片还没有加载出来动画就已经开始了这样的情况。现在网上针对这方面实现的辅助库有很多，那其实自己写一段逻辑去进行判断也并不是一件困难的事情，下面的代码大致地完成了我们要做的核心功能（判断某个图片是否加载了，如果加载了就去执行callback方法即可）：
```javascript
function loadImage(url, callback) {
	var img = new Image(); //创建一个Image对象，实现图片的预下载
	img.src = url;
	if (img.complete) { //如果图片已经存在于浏览器缓存，直接调用回调函数
		callback.call(img);
		return; // 直接返回，不用再处理onload事件
	}
	img.onload = function () { //图片下载完毕时异步调用callback函数。
		callback.call(img);//将回调函数的this替换为Image对象
	};
};
```
从实现上来说不是困难的，但在开发的过程中也遇到了下面的一些问题，给大家提供参考：
1. 刚开始时，图片直接写在页面中，通过img.onload的方法来进行判断是否加载完成，会出现这样的问题：图片已经加载完了，但是由于脚本的加载的延迟，加载完成的img并没有触发onload方法，导致并不能判断全部图片的加载情况。所以图片应该在脚本中进行添加，这样保证可以通过脚本来判断图片是否已经加载完成。
2. 图片加载失败或者图片加载超时情况的判断：在网络状况不是很好的情况下，常会出现图片加载失败这样的情形；在这种情况下，我们可以提供判断来帮助进行页面的当前加载的判断，具体的方式是通过onerror方法来进行判断即可。

#### 动画效果

![](http://cdn1.showjoy.com/images/3d/3dc27d8bfaf549869912bfdad8c843c6.jpg)

在制作这样的动画页面时，设计师通常会给到我们一份初步成形的设计稿，在这个设计稿中，我们可以基本看到整个动画的一个设计过程。在看完整个设计稿时，我的第一想法是，根据设计稿设计的动画，在脑海中过一遍后面可能制作出来的动画效果会是怎样的，在这样的一个基础上，是不是有什么技术实现的难点与可能并不能很好呈现的地方出现，在这个时候需要和设计师多沟通，了解在设计师心中具体的展现方式，和实际的技术相集合，并针对这些地方进行技术的查询，看看是不是有好的解决方案。通常情况下，很多细节的地方要多看多想，和设计师达成一个展示效果的共识，将对后面的页面开发有很大的帮助。
整个实现的过程大致如下：
1. 将所有的页面都先静态的方式切出来，为后面的动画效果制作做铺垫。
2. 逐个页面的动画效果的制作与调试。
3. 页面之间动画效果的串联。
4. 在初稿出来之后，和设计师进行不断的调整与修改。
5. 和音乐进行配合进行最后的调整。

那下面就针对上面的一个个点来给大家进行详细的讲解：
##### 第一步：切图、基本的页面成型
在这一步中，页面开发过程的结构是比较重要的，好的结构可以帮助在开发后期进行的调试与修改。下面是我自己进行的页面结构的制作，将每一段动画的内容分别放置在不同的div中，需要调试哪一段就设置哪一段为可见即可。

![](http://cdn1.showjoy.com/images/21/21b95c1195b346b3998e5da2e9cda97d.png)

##### 第二步：各页面动画效果制作
在这个阶段，主要进行的是各个页面动画的制作。动画基本采用css3动画来实现，不过由于我们在动画的播放过程中是需要通过一些动作来进行触发进行的，所以会在脚本中控制页面中各元素的动画。在实现中写了一个动画设置的通用的方法来帮助进行动画的定义：

![](http://cdn1.showjoy.com/images/27/2728e9f49ae04e738270113e15847bff.png)

通过上面的函数，后面就直接针对对各个元素进行动画的定义了：

![](http://cdn1.showjoy.com/images/cd/cd2bc43e332742c6bc6248b26612dbbd.png)

在CSS3动画方面，具体的实现并没有什么困难的地方，就是时间上需要不断进行调整，还有就是针对贝塞尔曲线，在一些动画需要有时间曲线上的控制的时候，需要我们不断地进行尝试与调整。[这里推荐一个网站可以让我们对贝塞尔曲线有更加详细的了解。](http://www.xuanfengge.com/easeing/easeing/#)
还有就是针对动画的定义方面，css3动画在实现上来说，并不是很困难，不过我们需要不断地根据我们设置的时间和要实现的效果去进行一个进行过程的百分比和放大缩小程度上的调整，是一个漫长的过程，需要不断地进行尝试。当然也可以到网上进行相关动画的搜索，也为动画的实现提供了很多的可选。

![](http://cdn1.showjoy.com/images/b2/b2587160b4e242018ad5a9f01cc2a8f6.png)

在上图中实现的是一个从大到小并且在最后会有震动这样的一个效果。在涉及到前后变化的时候我们还是通常使用scale来直接实现了，而没有涉及到3d的动画（通过控制z轴的变化也是可以实现的）。不过在某些地方我们需要实现我们的3d旋转效果，这个效果还是很好看的，在实现上也一点都不困难：

![](http://cdn1.showjoy.com/images/54/54dd150916834d1e8859e99162993cca.png)

那在这个页面动画上，当庚正两个字坠落下去后，会有花瓣散开这样的一个效果。为了让花瓣散开的感觉更加的好看，也是添加了花瓣3d旋转的效果。具体的实现我们可以看看下面的代码：
```CSS
@-webkit-keyframes session02Flower02 {
  0%{
    -webkit-transform: scale(1) translate3d(40px, 0px, 0) rotate3d(1,0,1,210deg);
    opacity: 0;
  }
  20%{
    opacity: 1;
  }
  70%{
    opacity: 1;
  }
  100%{
    -webkit-transform: scale(4) translate3d(-40px, 20px, 30px) rotate3d(1,1,0,100deg);
    opacity: 0;
  }
}
```
我们可以看到其实也只是多了一个rotate3d这样的一个变换的定义即可（花瓣由小到大，包括位移上的变动以及旋转上的变化）。[具体的3d动画应用大家可以看这篇文章，很详细地讲述了3d动画的实现](http://www.w3cplus.com/css3/css3-3d-transform.html)。（2d动画和3d动画的不同在于多出了z轴的控制，只要了解了其参数是如何设置的，就很容易上手了）由于css动画的实现终究是比脚本控制要有更大的优势，所以我们在实现动画的过程中，尽量减少脚本动画的使用，采用css动画有更好的性能表现。
有一点需要说明的是关于transform-origin的应用的，在动画的控制过程中，我们还是会经常用到这个属性进行控制，因为我们需要控制动画的一个中心点，来保证动画的展现。[（了解具体使用请看这里）](http://www.w3cplus.com/css3/transform-origin.html)
#### 其他
###### parallax库的应用
在实现上我们后来加入了陀螺仪的辅助，也就是在晃动手机时，页面上的元素也会根据你的陀螺仪的变化来进行位置上的变化。这个库还是很好用的，大小压缩之后也不过9kb，整体使用的方法比较见简单，后面将会简单地描述一下其使用，[具体提供的API可以根据其在github上开源的文档来进行了解。](https://github.com/wagerfield/parallax)
```html
<ul id="scene">
  <li class="layer" data-depth="0.00"><img src="graphics/layer1.png"></li>
  <li class="layer" data-depth="0.20"><img src="graphics/layer2.png"></li>
  <li class="layer" data-depth="0.40"><img src="graphics/layer3.png"></li>
  <li class="layer" data-depth="0.60"><img src="graphics/layer4.png"></li>
  <li class="layer" data-depth="0.80"><img src="graphics/layer5.png"></li>
  <li class="layer" data-depth="1.00"><img src="graphics/layer6.png"></li>
</ul>
```
在上面的代码中，ul代表了外部的框，里面的li元素即为各个会根据陀螺仪变换的元素。其中我们在使用的时候```class="layer"```这个是不可少的，而```data-depth```则是表示这个元素的上下关系的，具体其根据陀螺仪的变化而产生的移动有一个这样的公式来进行计算，可以根据这个了解其移动的计算规则:
```
xMotion = parentElement.width  * (scalarX / 100) * layerDepth
yMotion = parentElement.height * (scalarY / 100) * layerDepth
```
在完成上述的html开发后，直接在脚本中采用：
```javascript
var scene = document.getElementById('scene');
var parallax = new Parallax(scene);
```
既可以完成其默认的实现。（在库中包含了很多可以配置的内容，可以通过配置不同的参数来实现不同的陀螺仪晃动效果）

###### 每个页面的动画在实现的函数上进行分离，助于调试

![](http://cdn1.showjoy.com/images/c2/c24c34a7f1524528bc9316b576ee23c7.png)

在实现中，各个页面的动画是分开的，这样我们如果要调试某个页面的动画，只需要运行该页面的动画函数即可进行调用，方便我们的动画制作。

#### 结束语
以上便是我在开发更正计划H5宣传页面后的一些感想，其实H5动画在技术实现上并不是很困难，但是在很多细节的地方需要注意，也需要一直和设计师保持良好的沟通，共同完成这个动画。同时由于我们动画在H5上面执行的原因，我们还是要时时关注我们的性能，多做优化，多做尝试。